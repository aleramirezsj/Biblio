<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow rounded-4 border border-light">
            <div class="card-body">
                <div class="mb-3 fw-bold" style="color: #274472;">¿Qué libro estás buscando?</div>
                <div class="mb-3">
                    <input class="form-control form-control-lg rounded-3 border-primary"
                           placeholder="Buscar por título, autor, editorial..."
                           @bind="SearchText" />
                </div>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-primary" @onclick="HandleBuscar">🔍 Buscar</button>
                    <button class="btn btn-outline-primary" @onclick="ToggleFiltros">⚙️ Filtros de búsqueda</button>
                </div>
                @if (MostrarFiltros)
                {
                    <div class="card p-3 mb-3" style="background-color: AliceBlue; border-color: LightBlue;">
                        <div class="fw-bold mb-2" style="color: #274472;">🔎 Buscar en:</div>
                        <div class="row mb-2">
                            <div class="col-6 d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2" @bind="FiltrarPorTitulo" />
                                <label class="form-check-label">📖 Título</label>
                            </div>
                            <div class="col-6 d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2" @bind="FiltrarPorAutor" />
                                <label class="form-check-label">✍️ Autor</label>
                            </div>
                            <div class="col-6 d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2" @bind="FiltrarPorEditorial" />
                                <label class="form-check-label">🏢 Editorial</label>
                            </div>
                            <div class="col-6 d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2" @bind="FiltrarPorGenero" />
                                <label class="form-check-label">🎭 Género</label>
                            </div>
                            <div class="col-6 d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2" @bind="FiltrarPorSinopsis" />
                                <label class="form-check-label">🔦 Sinopsis</label>
                            </div>
                        </div>
                        <button class="btn btn-warning text-white mt-2" @onclick="LimpiarBusqueda">🗑️ Limpiar búsqueda</button>
                    </div>
                }
                @if (IsBusy)
                {
                    <div class="d-flex align-items-center justify-content-center gap-2 mt-2">
                        <div class="spinner-border text-primary" role="status"></div>
                        <span class="text-primary">Buscando libros...</span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public List<Libro>? Libros { get; set; } = new();
    [Parameter]
    public EventCallback<FilterLibroDTO> OnBuscar { get; set; }

    // Estado de búsqueda y filtros
    string SearchText { get; set; } = "";
    bool MostrarFiltros { get; set; } = false;
    private bool filtrarPorTitulo;

    public bool FiltrarPorTitulo
    {
        get { return filtrarPorTitulo; }
        set { filtrarPorTitulo = value; 
            if (value)
            {
                FiltrarPorSinopsis = false;
            }
        }
    }
    private bool filtrarPorAutor;

    public bool FiltrarPorAutor
    {
        get { return filtrarPorAutor; }
        set { filtrarPorAutor = value; 
            if (value)
            {
                FiltrarPorSinopsis = false;
            }
        }
    }
    
    private bool filtrarPorEditorial;

    public bool FiltrarPorEditorial
    {
        get { return filtrarPorEditorial; }
        set { filtrarPorEditorial = value; 
            if (value)
            {
                FiltrarPorSinopsis = false;
            }
        }
    }
    
    private bool filtrarPorGenero;

    public bool FiltrarPorGenero
    {
        get { return filtrarPorGenero; }
        set { filtrarPorGenero = value; 
            if (value)
            {
                FiltrarPorSinopsis = false;
            }
        }
    }
    
    
    //desactiva todos los otros filtros si este esta activo
    private bool filtrarPorSinopsis;

    public bool FiltrarPorSinopsis
    {
        get { return filtrarPorSinopsis; }
        set { filtrarPorSinopsis = value; 
            if (value)
            {
                FiltrarPorTitulo = false;
                FiltrarPorAutor = false;
                FiltrarPorEditorial = false;
                FiltrarPorGenero = false;
            }
        }
    }
    

    bool IsBusy { get; set; } = false;


    void ToggleFiltros() => MostrarFiltros = !MostrarFiltros;

    async Task LimpiarBusqueda()
    {
        SearchText = "";
        FiltrarPorTitulo = true;
        FiltrarPorAutor = false;
        FiltrarPorEditorial = false;
        FiltrarPorGenero = false;
        FiltrarPorSinopsis = false;
        await HandleBuscar();
    }

    private async Task HandleBuscar()
    {
        FilterLibroDTO filterDTO = new()
        {
            SearchText = SearchText,
            ForTitulo = FiltrarPorTitulo,
            ForAutor = FiltrarPorAutor,
            ForEditorial = FiltrarPorEditorial,
            ForGenero = FiltrarPorGenero,
            ForSinopsis = FiltrarPorSinopsis
        };
        IsBusy = true;
        await OnBuscar.InvokeAsync(filterDTO);
        IsBusy = false;
    }
}
